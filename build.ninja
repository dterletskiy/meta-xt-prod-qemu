ninja_required_version = 1.10
rule regenerate
  command = moulin /mnt/host/epam/meta-xt-prod-qemu//prod-qemu.yaml
  generator = 1

build build.ninja: regenerate /mnt/host/epam/meta-xt-prod-qemu//prod-qemu.yaml

rule rouge
  command = rouge /mnt/host/epam/meta-xt-prod-qemu//prod-qemu.yaml -fi $image_name -o $out

rule gzip
  command = gzip -1kf $in

rule bmaptool
  command = bmaptool create $in -o $out

rule yocto_init_env
  command = bash -c "cd $yocto_dir && source poky/oe-init-build-env $work_dir"
  description = Initialize Yocto build environment
  restat = 1

rule yocto_add_layers
  command = bash -c "cd $yocto_dir && source poky/oe-init-build-env $work_dir && bitbake-layers add-layer $layers && $
      touch $out"
  description = Add yocto layers
  pool = console
  restat = 1

rule yocto_update_conf
  command = cd $yocto_dir && echo '# Code generated by moulin. All manual changes will be lost' > $
      $work_dir/conf/moulin.conf && for x in $conf; do echo $$x >> $work_dir/conf/moulin.conf; done && sed "/require $
      moulin\.conf/d" -i $work_dir/conf/local.conf && echo 'require moulin.conf' >> $work_dir/conf/local.conf && $
      touch -r $work_dir/conf/bblayers.conf $work_dir/conf/local.conf
  description = Update local.conf

rule yocto_build
  command = bash -c "moulin /mnt/host/epam/meta-xt-prod-qemu//prod-qemu.yaml --fetcherdep $name && cd $yocto_dir && $
      source poky/oe-init-build-env $work_dir && bitbake $target"
  description = Yocto Build: $name
  depfile = .moulin_$name.d
  pool = console
  restat = 1
  deps = gcc
rule git_clone
  command = GIT_SSH_COMMAND='ssh -o BatchMode=yes' GIT_TERMINAL_PROMPT=0 git clone $git_clone_opts -q $git_url $
      $git_dir  && touch $out
  description = git clone

rule git_checkout
  command = git -C $git_dir checkout $git_checkout_opts -q $git_rev && touch $out
  description = git checkout

build yocto/poky /mnt/host/epam/meta-xt-prod-qemu/.stamps/yocto--yocto-poky--git---git.yoctoproject.org-poky--clone: $
    git_clone
  git_url = git://git.yoctoproject.org/poky
  git_dir = yocto/poky
  git_clone_opts = --no-checkout

build /mnt/host/epam/meta-xt-prod-qemu/.stamps/yocto--yocto-poky--git---git.yoctoproject.org-poky--checkout: $
    git_checkout /mnt/host/epam/meta-xt-prod-qemu/.stamps/yocto--yocto-poky--git---git.yoctoproject.org-poky--clone
  git_rev = 2f136ed7ed372a5eceb68cb6e1cdbc01c90b88d4
  git_dir = yocto/poky
  git_checkout_opts = 

build yocto/meta-openembedded $
    /mnt/host/epam/meta-xt-prod-qemu/.stamps/yocto--yocto-meta--openembedded--git---git.openembedded.org-meta--openembedded--clone: $
    git_clone
  git_url = git://git.openembedded.org/meta-openembedded
  git_dir = yocto/meta-openembedded
  git_clone_opts = --no-checkout

build $
    /mnt/host/epam/meta-xt-prod-qemu/.stamps/yocto--yocto-meta--openembedded--git---git.openembedded.org-meta--openembedded--checkout: $
    git_checkout $
    /mnt/host/epam/meta-xt-prod-qemu/.stamps/yocto--yocto-meta--openembedded--git---git.openembedded.org-meta--openembedded--clone
  git_rev = 2e3126c9c16bb3df0560f6b3896d01539a3bfad7
  git_dir = yocto/meta-openembedded
  git_checkout_opts = 

build yocto/meta-virtualization $
    /mnt/host/epam/meta-xt-prod-qemu/.stamps/yocto--yocto-meta--virtualization--git---git.yoctoproject.org-meta--virtualization--clone: $
    git_clone
  git_url = git://git.yoctoproject.org/meta-virtualization
  git_dir = yocto/meta-virtualization
  git_clone_opts = --no-checkout

build $
    /mnt/host/epam/meta-xt-prod-qemu/.stamps/yocto--yocto-meta--virtualization--git---git.yoctoproject.org-meta--virtualization--checkout: $
    git_checkout $
    /mnt/host/epam/meta-xt-prod-qemu/.stamps/yocto--yocto-meta--virtualization--git---git.yoctoproject.org-meta--virtualization--clone
  git_rev = 6f3c1d8f90947408a6587be222fec575a1ca5195
  git_dir = yocto/meta-virtualization
  git_checkout_opts = 

build yocto/meta-xt-common $
    /mnt/host/epam/meta-xt-prod-qemu/.stamps/yocto--yocto-meta--xt--common--https---github.com-xen--troops-meta--xt--common.git--clone: $
    git_clone
  git_url = https://github.com/xen-troops/meta-xt-common.git
  git_dir = yocto/meta-xt-common
  git_clone_opts = --no-checkout

build $
    /mnt/host/epam/meta-xt-prod-qemu/.stamps/yocto--yocto-meta--xt--common--https---github.com-xen--troops-meta--xt--common.git--checkout: $
    git_checkout $
    /mnt/host/epam/meta-xt-prod-qemu/.stamps/yocto--yocto-meta--xt--common--https---github.com-xen--troops-meta--xt--common.git--clone
  git_rev = 0890d85d29c29265663b5e0eac7998916462c05c
  git_dir = yocto/meta-xt-common
  git_checkout_opts = 

build yocto/meta-xt-prod-qemu $
    /mnt/host/epam/meta-xt-prod-qemu/.stamps/yocto--yocto-meta--xt--prod--qemu--https---github.com-dterletskiy-meta--xt--prod--qemu.git--clone: $
    git_clone
  git_url = https://github.com/dterletskiy/meta-xt-prod-qemu.git
  git_dir = yocto/meta-xt-prod-qemu
  git_clone_opts = --no-checkout

build $
    /mnt/host/epam/meta-xt-prod-qemu/.stamps/yocto--yocto-meta--xt--prod--qemu--https---github.com-dterletskiy-meta--xt--prod--qemu.git--checkout: $
    git_checkout $
    /mnt/host/epam/meta-xt-prod-qemu/.stamps/yocto--yocto-meta--xt--prod--qemu--https---github.com-dterletskiy-meta--xt--prod--qemu.git--clone
  git_rev = main
  git_dir = yocto/meta-xt-prod-qemu
  git_checkout_opts = 

build fetch-dom0: phony $
    /mnt/host/epam/meta-xt-prod-qemu/.stamps/yocto--yocto-poky--git---git.yoctoproject.org-poky--checkout $
    /mnt/host/epam/meta-xt-prod-qemu/.stamps/yocto--yocto-meta--openembedded--git---git.openembedded.org-meta--openembedded--checkout $
    /mnt/host/epam/meta-xt-prod-qemu/.stamps/yocto--yocto-meta--virtualization--git---git.yoctoproject.org-meta--virtualization--checkout $
    /mnt/host/epam/meta-xt-prod-qemu/.stamps/yocto--yocto-meta--xt--common--https---github.com-xen--troops-meta--xt--common.git--checkout $
    /mnt/host/epam/meta-xt-prod-qemu/.stamps/yocto--yocto-meta--xt--prod--qemu--https---github.com-dterletskiy-meta--xt--prod--qemu.git--checkout

build yocto/build-dom0/conf/local.conf: yocto_init_env $
    /mnt/host/epam/meta-xt-prod-qemu/.stamps/yocto--yocto-poky--git---git.yoctoproject.org-poky--checkout $
    /mnt/host/epam/meta-xt-prod-qemu/.stamps/yocto--yocto-meta--openembedded--git---git.openembedded.org-meta--openembedded--checkout $
    /mnt/host/epam/meta-xt-prod-qemu/.stamps/yocto--yocto-meta--virtualization--git---git.yoctoproject.org-meta--virtualization--checkout $
    /mnt/host/epam/meta-xt-prod-qemu/.stamps/yocto--yocto-meta--xt--common--https---github.com-xen--troops-meta--xt--common.git--checkout $
    /mnt/host/epam/meta-xt-prod-qemu/.stamps/yocto--yocto-meta--xt--prod--qemu--https---github.com-dterletskiy-meta--xt--prod--qemu.git--checkout
  yocto_dir = yocto
  work_dir = build-dom0
build /mnt/host/epam/meta-xt-prod-qemu/.stamps/yocto--build--dom0--yocto--layers: yocto_add_layers $
    yocto/build-dom0/conf/local.conf
  yocto_dir = yocto
  work_dir = build-dom0
  layers = ../meta-openembedded/meta-oe ../meta-openembedded/meta-filesystems ../meta-openembedded/meta-python $
      ../meta-openembedded/meta-networking ../meta-virtualization ../meta-xt-common/meta-xt-domx $
      ../meta-xt-common/meta-xt-dom0 ../meta-xt-common/meta-xt-control-domain $
      ../meta-xt-prod-qemu/layers/meta-xt-domx-qemu ../meta-xt-prod-qemu/layers/meta-xt-dom0-qemu
build yocto/build-dom0/conf/moulin.conf: yocto_update_conf $
    /mnt/host/epam/meta-xt-prod-qemu/.stamps/yocto--build--dom0--yocto--layers
  yocto_dir = yocto
  work_dir = build-dom0
  conf = 'SSTATE_DIR = "$${TOPDIR}/../common_data/sstate"' 'DL_DIR = "$${TOPDIR}/../common_data/downloads"' $
      'DISTRO_FEATURES:append = " xen"' 'DISTRO_FEATURES:remove = "acl alsa argp pcmcia usbgadget usbhost opengl $
      ptest multiarch wayland vulkan sysvinit x11 gtk gobject-introspection-data wifi nfc bluetooth irda zeroconf $
      3g"' 'BAD_RECOMMENDATIONS:append = " udev-hwdb"' 'BUILD_REPRODUCIBLE_BINARIES = "1"' 'INIT_MANAGER = "systemd"' $
      'RDEPENDS_$${KERNEL_PACKAGE_NAME}-base = ""' 'SKIP_META_VIRT_SANITY_CHECK = "1"' 'SERIAL_CONSOLES = $
      "115200;hvc0"' 'PREFERRED_VERSION_xen = "4.19.0+stable%"' 'PREFERRED_VERSION_xen-tools = "4.19+stable%"' $
      'MACHINE = "generic-armv8-xt"' 'XT_DOM_NAME = "dom0"' 'XT_DOMD_CONFIG_NAME = "domd.cfg"' 'XT_DOMD_DTB_NAME = $
      "qemu.dtb"' 'XT_GUEST_INSTALL = "domd"' 'BBMASK:append = " $
      meta-xt-common/meta-xt-control-domain/recipes-guest/domu"' 'BBMASK:append = " $
      meta-xt-prod-qemu/layers/meta-xt-dom0-qemu/recipes-guests/domu/domu.bbappend"' 'EXTERNALSRC:pn-domd = $
      "/mnt/host/epam/meta-xt-prod-qemu/yocto/build-domd/tmp/deploy/images/generic-armv8-xt"'

build conf-dom0: phony yocto/build-dom0/conf/moulin.conf

build yocto/build-dom0/tmp/deploy/images/generic-armv8-xt/Image $
    yocto/build-dom0/tmp/deploy/images/generic-armv8-xt/core-image-thin-initramfs-generic-armv8-xt.rootfs.cpio.gz: $
    yocto_build yocto/build-domd/tmp/deploy/images/generic-armv8-xt/Image yocto/build-dom0/conf/moulin.conf
  yocto_dir = yocto
  work_dir = build-dom0
  target = core-image-thin-initramfs
  name = dom0
build dom0: phony yocto/build-dom0/tmp/deploy/images/generic-armv8-xt/Image $
    yocto/build-dom0/tmp/deploy/images/generic-armv8-xt/core-image-thin-initramfs-generic-armv8-xt.rootfs.cpio.gz

default dom0
build fetch-domd: phony $
    /mnt/host/epam/meta-xt-prod-qemu/.stamps/yocto--yocto-poky--git---git.yoctoproject.org-poky--checkout $
    /mnt/host/epam/meta-xt-prod-qemu/.stamps/yocto--yocto-meta--openembedded--git---git.openembedded.org-meta--openembedded--checkout $
    /mnt/host/epam/meta-xt-prod-qemu/.stamps/yocto--yocto-meta--virtualization--git---git.yoctoproject.org-meta--virtualization--checkout $
    /mnt/host/epam/meta-xt-prod-qemu/.stamps/yocto--yocto-meta--xt--common--https---github.com-xen--troops-meta--xt--common.git--checkout $
    /mnt/host/epam/meta-xt-prod-qemu/.stamps/yocto--yocto-meta--xt--prod--qemu--https---github.com-dterletskiy-meta--xt--prod--qemu.git--checkout

build yocto/build-domd/conf/local.conf: yocto_init_env $
    /mnt/host/epam/meta-xt-prod-qemu/.stamps/yocto--yocto-poky--git---git.yoctoproject.org-poky--checkout $
    /mnt/host/epam/meta-xt-prod-qemu/.stamps/yocto--yocto-meta--openembedded--git---git.openembedded.org-meta--openembedded--checkout $
    /mnt/host/epam/meta-xt-prod-qemu/.stamps/yocto--yocto-meta--virtualization--git---git.yoctoproject.org-meta--virtualization--checkout $
    /mnt/host/epam/meta-xt-prod-qemu/.stamps/yocto--yocto-meta--xt--common--https---github.com-xen--troops-meta--xt--common.git--checkout $
    /mnt/host/epam/meta-xt-prod-qemu/.stamps/yocto--yocto-meta--xt--prod--qemu--https---github.com-dterletskiy-meta--xt--prod--qemu.git--checkout
  yocto_dir = yocto
  work_dir = build-domd
build /mnt/host/epam/meta-xt-prod-qemu/.stamps/yocto--build--domd--yocto--layers: yocto_add_layers $
    yocto/build-domd/conf/local.conf
  yocto_dir = yocto
  work_dir = build-domd
  layers = ../meta-openembedded/meta-oe ../meta-openembedded/meta-filesystems ../meta-openembedded/meta-python $
      ../meta-openembedded/meta-networking ../meta-virtualization ../meta-xt-common/meta-xt-domx $
      ../meta-xt-common/meta-xt-driver-domain ../meta-xt-prod-qemu/layers/meta-xt-domx-qemu $
      ../meta-xt-prod-qemu/layers/meta-xt-domd-qemu
build yocto/build-domd/conf/moulin.conf: yocto_update_conf $
    /mnt/host/epam/meta-xt-prod-qemu/.stamps/yocto--build--domd--yocto--layers
  yocto_dir = yocto
  work_dir = build-domd
  conf = 'SSTATE_DIR = "$${TOPDIR}/../common_data/sstate"' 'DL_DIR = "$${TOPDIR}/../common_data/downloads"' $
      'DISTRO_FEATURES:append = " xen"' 'DISTRO_FEATURES:remove = "acl alsa argp pcmcia usbgadget usbhost opengl $
      ptest multiarch wayland vulkan sysvinit x11 gtk gobject-introspection-data wifi nfc bluetooth irda zeroconf $
      3g"' 'BAD_RECOMMENDATIONS:append = " udev-hwdb"' 'BUILD_REPRODUCIBLE_BINARIES = "1"' 'INIT_MANAGER = "systemd"' $
      'RDEPENDS_$${KERNEL_PACKAGE_NAME}-base = ""' 'SKIP_META_VIRT_SANITY_CHECK = "1"' 'SERIAL_CONSOLES = $
      "115200;hvc0"' 'PREFERRED_VERSION_xen = "4.19.0+stable%"' 'PREFERRED_VERSION_xen-tools = "4.19+stable%"' $
      'MACHINE = "generic-armv8-xt"' 'XT_DOM_NAME = "domd"'

build conf-domd: phony yocto/build-domd/conf/moulin.conf

build yocto/build-domd/tmp/deploy/images/generic-armv8-xt/Image $
    yocto/build-domd/tmp/deploy/images/generic-armv8-xt/qemu-image-minimal-generic-armv8-xt.rootfs.ext4 $
    yocto/build-domd/tmp/deploy/images/generic-armv8-xt/xen-generic-armv8-xt: yocto_build $
    yocto/build-domd/conf/moulin.conf
  yocto_dir = yocto
  work_dir = build-domd
  target = qemu-image-minimal
  name = domd
build domd: phony yocto/build-domd/tmp/deploy/images/generic-armv8-xt/Image $
    yocto/build-domd/tmp/deploy/images/generic-armv8-xt/qemu-image-minimal-generic-armv8-xt.rootfs.ext4 $
    yocto/build-domd/tmp/deploy/images/generic-armv8-xt/xen-generic-armv8-xt

build full.img: rouge yocto/build-dom0/tmp/deploy/images/generic-armv8-xt/Image $
    yocto/build-dom0/tmp/deploy/images/generic-armv8-xt/core-image-thin-initramfs-generic-armv8-xt.rootfs.cpio.gz $
    yocto/build-domd/tmp/deploy/images/generic-armv8-xt/xen-generic-armv8-xt.uImage $
    yocto/build-domd/tmp/deploy/images/generic-armv8-xt/qemu-image-minimal-generic-armv8-xt.rootfs.ext4
  pool = console
  image_name = full
build full.img.gz: gzip full.img
  pool = console
build full.img.bmap: bmaptool full.img
  pool = console
build image-full: phony full.img
